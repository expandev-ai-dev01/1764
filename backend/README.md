# StockBox Backend API

Backend REST API for StockBox - Inventory Management System

## Overview

StockBox is an inventory management system that tracks stock movements including additions, removals, and quantity changes. The backend provides a RESTful API built with Node.js, Express, and TypeScript.

## Technology Stack

- **Runtime**: Node.js 18+
- **Language**: TypeScript
- **Framework**: Express.js
- **Database**: Microsoft SQL Server (Azure SQL)
- **Validation**: Zod
- **Architecture**: REST API with schema isolation

## Project Structure

```
backend/
├── database/                    # SQL migration files (created by agents)
├── migrations/                  # Consolidated migrations (auto-generated)
├── src/
│   ├── api/                     # API controllers
│   │   └── v1/
│   │       ├── external/        # Public endpoints
│   │       └── internal/        # Authenticated endpoints
│   ├── routes/                  # Route definitions
│   ├── middleware/              # Express middleware
│   ├── services/                # Business logic
│   ├── utils/                   # Utility functions
│   ├── config/                  # Configuration
│   ├── migrations/              # Migration runner
│   └── server.ts                # Application entry point
├── package.json
├── tsconfig.json
└── .env
```

## Getting Started

### Prerequisites

- Node.js 18 or higher
- npm 9 or higher
- SQL Server database access

### Installation

1. Install dependencies:
```bash
npm install
```

2. Configure environment variables:
```bash
cp .env.example .env
```

Edit `.env` with your database credentials and configuration.

### Development

Run the development server with hot reload:
```bash
npm run dev
```

The API will be available at `http://localhost:3000/api/v1`

### Building

Build the TypeScript code:
```bash
npm run build
```

### Production

Start the production server:
```bash
npm start
```

## Database Migrations

The system uses an automatic migration system with schema isolation:

- Migrations run automatically on server startup
- Each project gets its own schema (e.g., `project_1757`)
- Database objects are recreated from scratch on each deploy
- Other project schemas remain untouched

### Migration Files

- **Source**: `backend/database/*.sql` (created by development agents)
- **Consolidated**: `backend/migrations/*.sql` (auto-generated by deploy service)
- **Runner**: `src/migrations/migration-runner.ts`

## API Versioning

The API uses URL path versioning:

- **Current**: `/api/v1/`
- **External**: `/api/v1/external/` (public endpoints)
- **Internal**: `/api/v1/internal/` (authenticated endpoints)

## Environment Variables

### Required

- `DB_SERVER` - Database server address
- `DB_NAME` - Database name
- `DB_USER` - Database username
- `DB_PASSWORD` - Database password
- `PROJECT_ID` - Project identifier for schema isolation

### Optional

- `PORT` - API port (default: 3000)
- `NODE_ENV` - Environment (development/production)
- `DB_PORT` - Database port (default: 1433)
- `DB_ENCRYPT` - Enable encryption (default: false)
- `SKIP_MIGRATIONS` - Skip migrations on startup (default: false)

## Health Check

The API provides a health check endpoint:

```
GET /health
```

Response:
```json
{
  "status": "healthy",
  "timestamp": "2024-01-17T12:00:00.000Z"
}
```

## Error Handling

All errors follow a consistent format:

```json
{
  "success": false,
  "error": {
    "message": "errorToken",
    "details": {}
  },
  "timestamp": "2024-01-17T12:00:00.000Z"
}
```

## Success Response

All successful responses follow this format:

```json
{
  "success": true,
  "data": {},
  "timestamp": "2024-01-17T12:00:00.000Z"
}
```

## Security

- Helmet.js for security headers
- CORS configuration for frontend access
- Multi-tenancy with account-based isolation
- Request validation with Zod schemas

## Testing

Run tests:
```bash
npm test
```

Run tests in watch mode:
```bash
npm run test:watch
```

## Linting

Run ESLint:
```bash
npm run lint
```

## License

MIT
